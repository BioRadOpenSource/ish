version: 2.1

jobs:
  test:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: Install pixi CLI
          command: |
            sudo apt-get update && sudo apt-get install -s libtinfo-dev
            # Fixup missing libtinfo symlink
            sudo ln -s /lib/x86_64-linux-gnu/libtinfo.so.6 /lib/x86_64-linux-gnu/libtinfo.so || true
            curl -fsSL https://pixi.sh/install.sh | sh
            export PATH="$PATH:/home/circleci/.pixi/bin"
            pixi --help
      - run:
          name: Install Mojo and deps
          command: |
            export PATH="$PATH:/home/circleci/.pixi/bin"
            pixi install --locked
      - run:
          name: Run tests
          command: |
            export PATH="$PATH:/home/circleci/.pixi/bin"
            pixi run pkglib
            # This is a total hack till 25.4 where the .pixi folder will be ignored by mojo test
            rm /home/circleci/project/.pixi/envs/default/test/test_test.mojo
            pixi run testlib
      - run:
          name: Run build
          command: |
            export PATH="$PATH:/home/circleci/.pixi/bin"
            pixi run build
            


workflows:
  version: 2
  test:
    jobs:
      - test
